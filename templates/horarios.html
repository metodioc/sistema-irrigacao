{% extends "layout.html" %}
{% block title %}Meus Horários{% endblock %}
{% block content %}
    <div class="content-section">
        {# NOVO: Usando a classe main-content-title para o título da página #}
        <div class="main-content-title">Meus Horários de Rega</div>
        {% if horarios %}
            <ul class="list-group">
                {% for horario in horarios %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Horário:</strong> {{ horario.hora }} <br>
                            <strong>Duração:</strong> {{ horario.duracao }} minutos <br>
                            <strong>Dias:</strong> {{ horario.dias_semana }} <br>
                            <strong>Status:</strong>
                            {% if horario.ativo %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </div>
                        <div>
                            <!-- Botão/Link para Editar -->
                            <a href="{{ url_for('editar_horario', horario_id=horario.id) }}" class="btn btn-info btn-sm me-2">Editar</a>
                            <!-- Botão de Excluir -->
                            <button type="button" class="btn btn-danger btn-sm" onclick="deletarHorario({{ horario.id }})">Excluir</button>
                            <!-- Botão de Ativar/Desativar -->
                            <button type="button" class="btn btn-warning btn-sm" onclick="toggleAtivo({{ horario.id }}, {{ 'false' if horario.ativo else 'true' }})">
                                {% if horario.ativo %}Desativar{% else %}Ativar{% endif %}
                            </button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Nenhum horário de rega cadastrado ainda. Adicione um!</p>
        {% endif %}

        <!-- Botão para Adicionar Horário (abre um modal) -->
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoHorario">
                Adicionar Novo Horário
            </button>
        </div>
    </div>

    <!-- MODAL para Adicionar Horário (mantido do código anterior) -->
    <div class="modal fade" id="modalNovoHorario" tabindex="-1" aria-labelledby="novoHorarioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="novoHorarioLabel">Adicionar Novo Horário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoHorario">
                        <div class="mb-3">
                            <label for="novaHora" class="form-label">Hora (HH:MM)</label>
                            <input type="text" class="form-control" id="novaHora" name="hora" placeholder="07:30" pattern="^(?:2[0-3]|[01]?[0-9]):(?:[0-5]?[0-9])$" required>
                            <small class="form-text text-muted">Formato: HH:MM (ex: 08:30)</small>
                        </div>
                        <div class="mb-3">
                            <label for="novaDuracao" class="form-label">Duração (minutos)</label>
                            <input type="number" class="form-control" id="novaDuracao" name="duracao" min="1" max="1440" placeholder="10" required>
                            <small class="form-text text-muted">Duração da rega em minutos (1 a 1440).</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dias da Semana</label><br>
                            {% for dia in ['Seg','Ter','Qua','Qui','Sex','Sab','Dom'] %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="novoDia_{{ dia }}" value="{{ dia }}">
                                    <label class="form-check-label" for="novoDia_{{ dia }}">{{ dia }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="salvarNovoHorario()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Seus scripts JavaScript para deletar/ativar horários (e o novo para adicionar) -->
    <script>
        function deletarHorario(id) {
            if (confirm('Tem certeza que deseja deletar este horário?')) {
                fetch(`/deletar_horario/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.sucesso) {
                        window.location.reload(); // Recarrega a página para atualizar a lista
                    } else {
                        alert('Erro ao deletar horário: ' + data.erro);
                    }
                })
                .catch(error => console.error('Erro:', error));
            }
        }

        function toggleAtivo(id, novoStatus) {
            fetch(`/ativar_horario/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ativo: novoStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload(); // Recarrega a página para atualizar a lista
                } else {
                    alert('Erro ao atualizar status: ' + data.erro);
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        // Função para salvar um novo horário via modal
        function salvarNovoHorario() {
            const hora = document.getElementById('novaHora').value;
            const duracao = document.getElementById('novaDuracao').value;
            const diasSelecionados = [];
            document.querySelectorAll('#formNovoHorario input[type=checkbox]:checked').forEach(c => diasSelecionados.push(c.value));
            
            fetch('/adicionar_horario', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    hora: hora,
                    duracao: duracao,
                    dias_semana: diasSelecionados.join(',')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    location.reload();
                } else {
                    alert('Erro ao adicionar horário: ' + data.erro);
                }
            })
            .catch(err => {
                console.error('Erro:', err);
                alert('Ocorreu um erro ao tentar adicionar o horário.');
            });
        }
    </script>
{% endblock content %}
